#!/bin/bash -xe

# $1 = image tag generated by Jenkins
# $2 = project name given to docker-compose
TAG="${1}"
PROJECT="${2}"

# Copy default example settings to a config
cat settings/example | docker config create "${PROJECT}_settings" -

# Copy HMAC key for ICE to a config
# NOTE: this *should* be a secret instead of config;
# but, secrets can only appear at /run/secrets/${NAME}
# doing this as config is *only* because this is a transient test
cat secrets/edd_ice_key | docker config create "${PROJECT}_ice_key" -

# get info on current node
THIS_NODE_ID="$(docker node inspect --format '{{.ID}}' self)"

# Rewrite docker-compose.override.yml to:
# 1. insert correct image tag, pointing to registry image
# 2. remove volume mounts from edd-core containers
# 3. add reference for settings config to edd-core containers
# 4. add reference for HMAC config to ice container
# 5. remove service definitions for nginx
# 6. add labels to services for easier checking later
# 7. add deploy constraints so scripts can exec later
# 8. strip ports exposed; not needed for testing
yq w -s - -i docker-compose.override.yml <<EOF
- command: update
  path: services.http.image
  value: "cr.ese.lbl.gov/jbei/edd-core:${TAG}"
- command: update
  path: services.websocket.image
  value: "cr.ese.lbl.gov/jbei/edd-core:${TAG}"
- command: update
  path: services.worker.image
  value: "cr.ese.lbl.gov/jbei/edd-core:${TAG}"
- command: delete
  path: services.http.volumes
- command: delete
  path: services.websocket.volumes
- command: delete
  path: services.worker.volumes
- command: update
  path: "configs.${PROJECT}_settings.external"
  value: true
- command: update
  path: services.http.configs
  value:
  - source: "${PROJECT}_settings"
    target: "/etc/edd/__init__.py"
- command: update
  path: services.websocket.configs
  value:
  - source: "${PROJECT}_settings"
    target: "/etc/edd/__init__.py"
- command: update
  path: services.worker.configs
  value:
  - source: "${PROJECT}_settings"
    target: "/etc/edd/__init__.py"
- command: update
  path: "configs.${PROJECT}_ice_key.external"
  value: true
- command: update
  path: services.ice.configs
  value:
  - source: "${PROJECT}_ice_key"
    target: "/usr/local/tomcat/data/rest-auth/edd"
- command: delete
  path: services.nginx
- command: delete
  path: services.nginx-gen
- command: update
  path: "services.ice.deploy.labels[0]"
  value: "org.jbei.jenkins.edd.ice=true"
- command: update
  path: "services.http.deploy.placement.constraints[0]"
  value: "node.id==${THIS_NODE_ID}"
- command: update
  path: "services.ice_db.deploy.placement.constraints[0]"
  value: "node.id==${THIS_NODE_ID}"
- command: delete
  path: "services.*.ports"
EOF

# define the stack
docker-compose config > stack.yml
# launch the stack with stack deploy
docker stack deploy --with-registry-auth -c stack.yml "${PROJECT}"

# wait for ice to finish coming up
ICE_IS_UP="false"
until [ "${ICE_IS_UP}" == "true" ]; do
    ICE_SERVICE_ID="$(docker service ls -f "label=org.jbei.jenkins.edd.ice" -f "label=com.docker.stack.namespace=${PROJECT}" -q)"
    if [ -z "${ICE_SERVICE_ID}" ]; then
        echo "Waiting for services to deploy"
        sleep 10
        continue
    fi
    ICE_TASK_ID="$(docker service ps -f "desired-state=running" -q "${ICE_SERVICE_ID}")"
    if [ -z "${ICE_TASK_ID}" ]; then
        echo "Waiting for services to replicate"
        sleep 10
        continue
    fi
    ICE_STATE="$(docker inspect --format '{{.Status.State}}' "${ICE_TASK_ID}")"
    if [ "$(docker inspect --format '{{.Status.State}}' "${ICE_TASK_ID}")" == "running" ]; then
        ICE_IS_UP="true"
    else
        echo "Waiting on ICE"
        sleep 10
    fi
done

# correct the default DATA_DIRECTORY
# add the default BLAST_INSTALL_DIR
SQL=$(cat <<'EOM'
UPDATE configuration
SET value = '/usr/local/tomcat/data'
WHERE key = 'DATA_DIRECTORY';
INSERT INTO configuration
VALUES (
    nextval('configuration_id_seq'),
    'BLAST_INSTALL_DIR',
    '/usr/bin'
);
EOM
)
# because deploy constraint, we know ice_db is on this host and we can exec in it
CONTAINER="$(docker ps -q -f "name=${PROJECT}_ice_db")"
docker exec "${CONTAINER}" psql -U iceuser -c "${SQL}" ice

# restart ICE so database config change in database applies
docker service update --force "${PROJECT}_ice"

# wait for http service to report healthy
HTTP_IS_UP="false"
until [ "${HTTP_IS_UP}" == "true" ]; do
    HTTP_SERVICE_ID="$(docker service ls -f "name=${PROJECT}_http" -q)"
    if [ -z "${HTTP_SERVICE_ID}" ]; then
        echo "Waiting for services to deploy"
        sleep 10
        continue
    fi
    HTTP_TASK_ID="$(docker service ps -f "desired-state=running" -q "${HTTP_SERVICE_ID}")"
    if [ -z "${HTTP_TASK_ID}" ]; then
        echo "Waiting for services to replicate"
        sleep 10
        continue
    fi
    if [ "$(docker inspect --format '{{.Status.State}}' "${HTTP_TASK_ID}")" == "running" ]; then
        HTTP_IS_UP="true"
    else
        echo "Waiting for http service to report healthy"
        sleep 10
    fi
done

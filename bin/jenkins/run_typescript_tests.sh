#!/bin/bash -xe

# $1 = image tag generated by Jenkins
TAG="${1}"
SERVER="cr.ese.lbl.gov"

# Load the TypeScript code into a node container
DOCKER_BUILDKIT=1 docker build \
    --progress plain \
    -t "jbei/edd-frontend:${TAG}" \
    -f - \
    . <<EOF
FROM ${SERVER}/jbei/edd-node:${TAG}
COPY ./typescript /run/typescript
COPY ./.prettierrc.js /run
EOF

# instruct script to save test output to test.log
{
    docker run --rm "jbei/edd-frontend:${TAG}" yarn test
} &> >(tee -a "test.log")
